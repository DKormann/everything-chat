var N=Object.defineProperty;var q=(n,e,t)=>e in n?N(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>(q(n,typeof e!="symbol"?e+"":e,t),t);import{s as H,n as v,o as j}from"../chunks/scheduler.BvLojk_z.js";import{S as D,i as P,e as b,s as x,c as g,y as C,h as M,d as W,g as p,o as L,j as f}from"../chunks/index.CDXNMAt8.js";class m{constructor(e,t){d(this,"value");d(this,"subscribers");d(this,"key");d(this,"hash");localStorage.getItem(e)===null?localStorage.setItem(e,JSON.stringify(t)):t=JSON.parse(localStorage.getItem(e)),this.value=t,this.subscribers=[],this.key=e,this.hash=JSON.stringify(t)}set(e){this.hash!=JSON.stringify(e)&&(this.value=e,localStorage.setItem(this.key,JSON.stringify(e)),this.subscribers.forEach(t=>t(e)))}subscribe(e){this.subscribers.push(e)}update(e){this.set(e(this.value))}}const K="https://chatserver.sciepedia.com/";function $(n,e){return new Promise((l,a)=>{let r=n.map(s=>({content:s.content,role:s.role}));fetch(K+"answer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:r})}).then(s=>{console.log(s);let o=s.body.getReader();function i({done:u,value:J}){if(u){l();return}e(new TextDecoder().decode(J)),o.read().then(i)}o.read().then(i)})})}let k,c,E,O,h=new m("last_message",""),T=new m("history",[]);const w=new Map;class y{constructor(e){d(this,"msg");d(this,"element");this.msg=e,this.element=document.createElement("div"),this.element.classList.add("message"),this.element.classList.add(e.value.role),this.setContent(e.value.content),k.appendChild(this.element),e.subscribe(t=>{this.setContent(t.content)})}setContent(e){this.element.innerHTML="";let t=document.createElement("div");t.classList.add("text"),this.element.appendChild(t);let l=0;e.split(`
`).forEach(a=>{if(a.startsWith("```")){l=(l+1)%2,t=document.createElement("div");let r=["text","code"][l];t.classList.add(r),this.element.appendChild(t)}else t.textContent+=a+`
`})}}function _(){return Math.random().toString(36).slice(-8)}function B(n){new y(new m("M_"+_(),{role:"user",content:n,parent_key:"",key:"",child_keys:[]}));let e=n.slice(1),t=e.split(" ");e=t[0],t.slice(1),new y(new m("M_"+_(),{role:"assistant",content:"Command received: "+e,parent_key:"",key:"",child_keys:[]}))}function I(n){if(n.startsWith("/"))return B(n);let e="M_"+_(),t=new m(e,{role:"user",content:n,parent_key:h.value,key:e,child_keys:[]});w.set(e,t),new y(t),h.set(e);let l="M_"+_(),a=new m(l,{role:"assistant",content:"...",parent_key:e,key:l,child_keys:[]}),r=[t.value];for(let s=0;s<10;s++){let o=S(r[0].parent_key);if(!o)break;r=[o.value,...r]}$(r,s=>{a.update(o=>(console.log(s),o.content=o.content.slice(0,o.content.length-3)+s+"...",o))}).then(()=>{a.update(s=>(s.content=s.content.slice(0,s.content.length-3),s)),h.set(l)}),new y(a)}function S(n){return n?w.has(n)?w.get(n):new m(n,{role:"system",content:"Message not found",parent_key:"",key:n,child_keys:[]}):null}function R(){if(k=document.querySelector("#chat"),c=document.querySelector("#inputmask>textarea"),E=document.querySelector("#sendbtn"),O=document.querySelector("#resetbtn"),c.addEventListener("keyup",n=>{if(n.key=="Enter"&&n.shiftKey){I(c.value.slice(0,-1)),c.value="";return}c.rows=c.value.split(`
`).length}),h.value){let n=function(t){t!=null&&(n(S(t.value.parent_key)),new y(t))},e=S(h.value);n(e)}E.addEventListener("click",()=>{I(c.value),c.value=""}),O.addEventListener("click",()=>{T.update(n=>n.concat([h.value])),h.set(""),k.innerHTML="",console.log(T)})}function z(n){let e,t="chat",l,a,r,s,o='<textarea id="" rows="1"></textarea> <button id="sendbtn">send</button> <button id="resetbtn">reset</button>';return{c(){e=b("h1"),e.textContent=t,l=x(),a=b("div"),r=x(),s=b("div"),s.innerHTML=o,this.h()},l(i){e=g(i,"H1",{"data-svelte-h":!0}),C(e)!=="svelte-uc8l2i"&&(e.textContent=t),l=M(i),a=g(i,"DIV",{id:!0}),W(a).forEach(p),r=M(i),s=g(i,"DIV",{id:!0,"data-svelte-h":!0}),C(s)!=="svelte-64pp4w"&&(s.innerHTML=o),this.h()},h(){L(a,"id","chat"),L(s,"id","inputmask")},m(i,u){f(i,e,u),f(i,l,u),f(i,a,u),f(i,r,u),f(i,s,u)},p:v,i:v,o:v,d(i){i&&(p(e),p(l),p(a),p(r),p(s))}}}function A(n){return j(R),[]}class U extends D{constructor(e){super(),P(this,e,A,z,H,{})}}export{U as component};

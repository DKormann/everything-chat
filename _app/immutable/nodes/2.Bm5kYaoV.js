var N=Object.defineProperty;var q=(n,e,t)=>e in n?N(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>(q(n,typeof e!="symbol"?e+"":e,t),t);import{s as H,n as v,o as j}from"../chunks/scheduler.BvLojk_z.js";import{S as D,i as P,e as b,s as k,c as y,y as w,h as C,d as K,g as p,o as L,j as m}from"../chunks/index.CDXNMAt8.js";class f{constructor(e,t){d(this,"value");d(this,"subscribers");d(this,"key");d(this,"hash");localStorage.getItem(e)===null?localStorage.setItem(e,JSON.stringify(t)):t=JSON.parse(localStorage.getItem(e)),this.value=t,this.subscribers=[],this.key=e,this.hash=JSON.stringify(t)}set(e){this.hash!=JSON.stringify(e)&&(this.value=e,localStorage.setItem(this.key,JSON.stringify(e)),this.subscribers.forEach(t=>t(e)))}subscribe(e){this.subscribers.push(e)}update(e){this.set(e(this.value))}}const W="https://chatserver.sciepedia.com/";function $(n,e){return new Promise((a,l)=>{let r=n.map(s=>({content:s.content,role:s.role}));fetch(W+"answer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:r})}).then(s=>{console.log(s);let o=s.body.getReader();function i({done:u,value:J}){if(u){a();return}e(new TextDecoder().decode(J)),o.read().then(i)}o.read().then(i)})})}let _,c,E,M,h=new f("last_message",""),O=new f("history",[]);const g=new Map;class S{constructor(e){d(this,"msg");d(this,"element");this.msg=e,this.element=document.createElement("div"),this.element.classList.add("message"),this.element.classList.add(e.value.role),this.setContent(e.value.content),_.appendChild(this.element),e.subscribe(t=>{this.setContent(t.content)})}setContent(e){this.element.innerHTML="";let t=document.createElement("div");t.classList.add("text"),this.element.appendChild(t);let a=0;e.split(`
`).forEach(l=>{if(l.startsWith("```")){a=(a+1)%2,t=document.createElement("div");let r=["text","code"][a];t.classList.add(r),this.element.appendChild(t)}else t.textContent+=l+`
`})}}function T(){return Math.random().toString(36).slice(-8)}function I(n){let e="M_"+T(),t=new f(e,{role:"user",content:n,parent_key:h.value,key:e,child_keys:[]});g.set(e,t),new S(t),h.set(e);let a="M_"+T(),l=new f(a,{role:"assistant",content:"...",parent_key:e,key:a,child_keys:[]}),r=[t.value];for(let s=0;s<10;s++){let o=x(r[0].parent_key);if(!o)break;r=[o.value,...r]}$(r,s=>{l.update(o=>(console.log(s),o.content=o.content.slice(0,o.content.length-3)+s+"...",o))}).then(()=>{l.update(s=>(s.content=s.content.slice(0,s.content.length-3),s)),h.set(a)}),new S(l)}function x(n){return n?g.has(n)?g.get(n):new f(n,{role:"system",content:"Message not found",parent_key:"",key:n,child_keys:[]}):null}function B(){if(_=document.querySelector("#chat"),c=document.querySelector("#inputmask>textarea"),E=document.querySelector("#sendbtn"),M=document.querySelector("#resetbtn"),c.addEventListener("keyup",n=>{if(n.key=="Enter"&&n.shiftKey){I(c.value.slice(0,-1)),c.value="";return}c.rows=c.value.split(`
`).length}),h.value){let n=function(t){t!=null&&(n(x(t.value.parent_key)),new S(t))},e=x(h.value);n(e)}E.addEventListener("click",()=>{I(c.value),c.value=""}),M.addEventListener("click",()=>{O.update(n=>n.concat([h.value])),h.set(""),_.innerHTML="",console.log(O)})}function R(n){let e,t="chat",a,l,r,s,o='<textarea id="" rows="1"></textarea> <button id="sendbtn">send</button> <button id="resetbtn">reset</button>';return{c(){e=b("h1"),e.textContent=t,a=k(),l=b("div"),r=k(),s=b("div"),s.innerHTML=o,this.h()},l(i){e=y(i,"H1",{"data-svelte-h":!0}),w(e)!=="svelte-uc8l2i"&&(e.textContent=t),a=C(i),l=y(i,"DIV",{id:!0}),K(l).forEach(p),r=C(i),s=y(i,"DIV",{id:!0,"data-svelte-h":!0}),w(s)!=="svelte-64pp4w"&&(s.innerHTML=o),this.h()},h(){L(l,"id","chat"),L(s,"id","inputmask")},m(i,u){m(i,e,u),m(i,a,u),m(i,l,u),m(i,r,u),m(i,s,u)},p:v,i:v,o:v,d(i){i&&(p(e),p(a),p(l),p(r),p(s))}}}function z(n){return j(B),[]}class Q extends D{constructor(e){super(),P(this,e,z,R,H,{})}}export{Q as component};
